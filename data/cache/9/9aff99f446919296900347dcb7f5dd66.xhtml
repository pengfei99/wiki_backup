
<p>
Biospecimens est le site permettant de faire des demandes de ressources biologiques. Bien qu&#039;il soit implémenté par l&#039;UTEC06 il est administré par l&#039;UTEC01.
</p>

<h2 class="sectionedit1" id="historique">Historique</h2>
<div class="level2">

<p>
Une première version (V1) a été implémentée par <code>Novius</code> (un prestataire externe). Puis BIOASTER a reprit l&#039;implémentation from scratch en faisant un portage isofonctionel (V1.5).
</p>

<p>
Le projet est codé en <code>PHP</code> (5.6) <em>via</em> le framework <a href="https://fr.wikipedia.org/wiki/Symfony" class="urlextern" title="https://fr.wikipedia.org/wiki/Symfony" rel="nofollow">symfony</a>
</p>

<p>
Le liens vers le projet redmine est <a href="https://devtools.bioaster.org/redmine/projects/biospecimens" class="urlextern" title="https://devtools.bioaster.org/redmine/projects/biospecimens" rel="nofollow">ici</a>
</p>

<p>
Le liens vers le dépôt gitlab est <a href="https://gitlab.in2p3.fr/bioaster/biospecimens-sf" class="urlextern" title="https://gitlab.in2p3.fr/bioaster/biospecimens-sf" rel="nofollow">ici</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Historique&quot;,&quot;hid&quot;:&quot;historique&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;162-681&quot;} -->
<h2 class="sectionedit2" id="historique_des_reunions">Historique des réunions</h2>
<div class="level2">

<p>
La liste des réunions est accessible <a href="/doku.php?id=biospecimens:reunions" class="wikilink1" title="biospecimens:reunions">ici</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Historique des r\u00e9unions&quot;,&quot;hid&quot;:&quot;historique_des_reunions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;682-786&quot;} -->
<h3 class="sectionedit3" id="reunions_de_travail">Réunions de travail</h3>
<div class="level3">

<p>
La liste des réunions de travail (ie plus axé technique) est accessible <a href="/doku.php?id=biospecimens:reunions:travail" class="wikilink1" title="biospecimens:reunions:travail">ici</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;R\u00e9unions de travail&quot;,&quot;hid&quot;:&quot;reunions_de_travail&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;787-930&quot;} -->
<h2 class="sectionedit4" id="serveurs">Serveurs</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Serveurs&quot;,&quot;hid&quot;:&quot;serveurs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;931-951&quot;} -->
<h3 class="sectionedit5" id="version_l5_symfony">Version l.5 (Symfony)</h3>
<div class="level3">

<p>
Une version de dev a été déployé sur l&#039;adresse ip <a href="http://10.70.3.12/fr/" class="urlextern" title="http://10.70.3.12/fr/" rel="nofollow">10.70.3.12</a> accessible <em>via</em> le nom de domaine <a href="http://biospecimens-15.bioaster.org" class="urlextern" title="http://biospecimens-15.bioaster.org" rel="nofollow">http://biospecimens-15.bioaster.org</a>
</p>

</div>

<h4 id="configuration_du_serveur">Configuration du serveur</h4>
<div class="level4">

<p>
<a href="/doku.php?id=biospecimens:server:config" class="wikilink2" title="biospecimens:server:config" rel="nofollow">Configuration côté serveur</a>
</p>

</div>

<h4 id="deploiement_de_la_version_15">Déploiement de la version 1.5</h4>
<div class="level4">

<p>
<a href="/doku.php?id=biospecimens:deploy" class="wikilink2" title="biospecimens:deploy" rel="nofollow">Déploiement de l&#039;application biospecimens</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Version l.5 (Symfony)&quot;,&quot;hid&quot;:&quot;version_l5_symfony&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;952-1390&quot;} -->
<h3 class="sectionedit6" id="version_1">Version 1</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> Version dev pour faire des tests : <a href="https://biospecimens-dev.bioaster.org/" class="urlextern" title="https://biospecimens-dev.bioaster.org/" rel="nofollow">https://biospecimens-dev.bioaster.org/</a></div>
</li>
<li class="level1"><div class="li"> Version prod : <a href="https://biospecimens.bioaster.org/" class="urlextern" title="https://biospecimens.bioaster.org/" rel="nofollow">https://biospecimens.bioaster.org/</a></div>
</li>
</ul>

</div>

<h4 id="details">Détails</h4>
<div class="level4">

</div>

<h5 id="acces">Accès</h5>
<div class="level5">

<p>
Ces serveurs sont sous FreeBSD et sont accessibles <em>via</em> l&#039;utilisateur <em>bioaster</em>. Le mot de passe se trouve dans le keepass (<code>User bioaster (sysunix)</code>). 
Le serveur est hébergé dans le répertoire suivant : <code>/usr/local/www/bioaster-biospecimens</code>
À partir du répertoire précédent, la configuration de la base de données est accessible dans <code>htdocs/local/config/db.config.php</code>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Version 1&quot;,&quot;hid&quot;:&quot;version_1&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;1391-1975&quot;} -->
<h3 class="sectionedit7" id="reprise_de_l_existant">Reprise de l&#039;existant</h3>
<div class="level3">

<p>
Les données ont été injectées de la V1 vers la V1.5 de la façon suivante :
</p>

</div>

<h4 id="versionning">Versionning</h4>
<div class="level4">

<p>
Les données <strong>ne doivent pas</strong> être versionnées.
</p>

<p>
Jusqu&#039;au 7 Aout 2017 les données sensibles été versionnés dans git et gitlab dans le repertoire dataFromV1.
Ce dernier a été ajouté au .gitignore puis les données ont été supprimées de la façon suivante :
</p>
<pre class="code bash"><span class="kw2">git filter-branch</span> <span class="re5">--force</span> <span class="re5">--index-filter</span> <span class="st_h">'git rm --cached --ignore-unmatch dataFromV1/* '</span> <span class="re5">--prune-empty</span> <span class="re5">--tag-name-filter</span> <span class="kw2">cat</span> <span class="re5">--</span> <span class="re5">--all</span>
<span class="kw2">git push</span> origin <span class="re5">--force</span> <span class="re5">--all</span>
<span class="kw2">git push</span> origin <span class="re5">--force</span> <span class="re5">--tags</span>
<span class="kw2">git reflog</span> expire <span class="re5">--expire</span>=now <span class="re5">--all</span>
<span class="kw2">git gc</span> <span class="re5">--prune</span>=now</pre>

</div>

<h4 id="dumping_non_social">Dumping non social</h4>
<div class="level4">

<p>
Les données de la BDD de Novius ont été <em>dumpées</em> (sql → csv).
</p>

<p>
Sur le serveur V1 :
</p>
<pre class="code bash"><span class="re2">outputDir</span>=<span class="st0">&quot;/tmp/TESTCLEMENT3&quot;</span>  <span class="co0"># à changer s'il faut</span>
<span class="kw2">mkdir</span> <span class="re1">$outputDir</span>
<span class="kw2">chmod</span> <span class="re5">-R</span> <span class="nu0">777</span> <span class="re1">$outputDir</span>
<span class="co0"># ne fonctionne que sur la prod</span>
mysqldump <span class="re5">-T</span> <span class="re1">$outputDir</span> nos_bioaster_searchproject <span class="re5">-u</span> nos_bioaster_sea <span class="re5">-p</span> <span class="re5">--skip-tz-utc</span>
<span class="co0"># sur la dev il faut passer en root</span>
mysqldump <span class="re5">-T</span> <span class="re1">$outputDir</span> nos_bioaster_searchproject <span class="re5">-u</span> root <span class="re5">-p</span> <span class="re5">--skip-tz-utc</span> </pre>

<p>
le mot de passe <code>nos_bioaster_sea</code> est dans <code>htdocs/local/config/db.config.php</code>
</p>

<p>
le mot de passe <code>root</code> est dans le keepass.
</p>

<p>
La commande précédente génère un fichier texte par table. Ils sont rapatriés ensuite :
</p>
<pre class="code bash"><span class="kw3">cd</span> <span class="re1">$OWNCLOUD</span><span class="sy0">/</span>Projet_Biospecimens<span class="sy0">/</span>exportDataFromV1<span class="sy0">/</span>prod <span class="co0"># à changer s'il faut</span>
<span class="kw2">scp</span> <span class="re5">-r</span> bioaster<span class="sy0">@</span>10.69.40.11:<span class="sy0">/</span>tmp<span class="sy0">/</span>TESTCLEMENT3<span class="sy0">/</span> .
<span class="kw2">rm</span> TESTCLEMENT3<span class="sy0">/*</span>sql
<span class="kw2">mv</span> TESTCLEMENT3<span class="sy0">/*</span> .
<span class="kw2">rm</span> <span class="re5">-rf</span> TESTCLEMENT3<span class="sy0">/</span></pre>

<p>
&lt;WRAP center round alert 60%&gt;
Veuillez modifier le fichier <code>dataFromV1/bioaster_societe.txt</code> en enlevant le saut de ligne !
&lt;/WRAP&gt;
</p>

<p>
&lt;WRAP center round alert 60%&gt;
Sur libreoffice, modifiez les saut de ligne par des “|” puis remplacer les à nouveau en saut de ligne en PHP !
&lt;/WRAP&gt;
</p>

<p>
Le formulaire “partager de l&#039;information relative à vos collections” doit être exporté via le backoffice puis copier dans le répertoire désiré.
</p>
<pre class="code bash">outputDir = <span class="st_h">'$OWNCLOUD/Projet_Biospecimens/exportDataFromV1/'</span>
<span class="kw2">cp</span> ~<span class="sy0">/</span>Téléchargements<span class="sy0">/</span>partager-de-l<span class="co3">\'</span>information-relative-à-vos-collections.csv <span class="co1">${outputDir}</span><span class="sy0">/</span>partager-de-linformation-relative-à-vos-collections.csv</pre>

</div>

<h4 id="fichiers_joints">Fichiers joints</h4>
<div class="level4">

<p>
Les fichiers joints ont été exportés comme ceci :
</p>
<pre class="code bash"><span class="kw3">cd</span> <span class="re1">$OWNCLOUD</span><span class="sy0">/</span>Projet_Biospecimens<span class="sy0">/</span>exportDataFromV1
<span class="kw2">mkdir</span> uploadedFiles
<span class="kw2">scp</span> <span class="re5">-r</span> bioaster<span class="sy0">@</span>biospecimens.bioaster.org:<span class="sy0">/</span>usr<span class="sy0">/</span>local<span class="sy0">/</span>www<span class="sy0">/</span>bioaster-biospecimens<span class="sy0">/</span>htdocs<span class="sy0">/</span>local<span class="sy0">/</span>data<span class="sy0">/</span>files<span class="sy0">/</span> uploadedFiles
<span class="kw2">mv</span> files<span class="sy0">/*</span> .
<span class="kw2">rm</span> <span class="re5">-rf</span> files</pre>

</div>

<h4 id="parsing">Parsing</h4>
<div class="level4">

<p>
Les fichiers exportés doivent être parsés de la façon suivante :
</p>
<pre class="code bash">outputDir = <span class="st_h">'$OWNCLOUD/Projet_Biospecimens/exportDataFromV1/'</span>
php app<span class="sy0">/</span>console biospecimens:populate <span class="co1">${outputDir}</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Reprise de l&#039;existant&quot;,&quot;hid&quot;:&quot;reprise_de_l_existant&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;1976-4757&quot;} -->
<h2 class="sectionedit8" id="tests">Tests</h2>
<div class="level2">

<p>
PHPUnit a été installé de la manière suivante :
</p>
<pre class="code bash">composer require <span class="re5">--dev</span> phpunit<span class="sy0">/</span>phpunit ^<span class="nu0">5.7</span>
composer update <span class="re5">--dev</span></pre>

<p>
et il s&#039;utilise ainsi :
</p>
<pre class="code bash"><span class="co0"># Pour tester toute l'application</span>
vendor<span class="sy0">/</span>phpunit<span class="sy0">/</span>phpunit<span class="sy0">/</span>phpunit <span class="re5">-c</span> app<span class="sy0">/</span>
<span class="co0"># Pour tester qu'une classe</span>
vendor<span class="sy0">/</span>phpunit<span class="sy0">/</span>phpunit<span class="sy0">/</span>phpunit src<span class="sy0">/</span>BS<span class="sy0">/</span>BiospecimensBundle<span class="sy0">/</span>Tests<span class="sy0">/</span>Controller<span class="sy0">/</span>ComputeCodeTest.php <span class="re5">-c</span> app<span class="sy0">/</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tests&quot;,&quot;hid&quot;:&quot;tests&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:8,&quot;range&quot;:&quot;4758-&quot;} -->