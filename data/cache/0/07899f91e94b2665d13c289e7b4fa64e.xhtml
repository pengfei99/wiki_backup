
<h1 class="sectionedit1" id="zeppelin_authentication">Zeppelin authentication</h1>
<div class="level1">

<p>
Zeppelin uses Shiro as the authentication framework. Shiro provides many authentication methods:
</p>
<ul>
<li class="level1"><div class="li"> File</div>
</li>
<li class="level1"><div class="li"> Ldap/AD</div>
</li>
<li class="level1"><div class="li"> PAM</div>
</li>
<li class="level1"><div class="li"> Knox SSO</div>
</li>
</ul>

<p>
To active one of the above authentication method, you need to edit the <strong>/usr/hdp/current/zeppelin-server/conf/shiro.ini</strong>
</p>

<p>
The shiro.ini has four main sections
</p>
<ul>
<li class="level1"><div class="li"> [users] : login and password for file authentication</div>
</li>
<li class="level1"><div class="li"> [main] : configuration for ldap/ad authentication</div>
</li>
<li class="level1"><div class="li"> [roles] : Define roles</div>
</li>
<li class="level1"><div class="li"> [urls] : Define authorization policy for the defined roles</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Zeppelin authentication&quot;,&quot;hid&quot;:&quot;zeppelin_authentication&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-542&quot;} -->
<h2 class="sectionedit2" id="file_authentication">1. File authentication</h2>
<div class="level2">

<p>
Edit the [users] section of shiro.ini file
</p>
<pre class="code"># general form
&lt;user_name&gt; = &lt;user_pwd&gt;, role
# example of list of users with their password allowed to access Zeppelin.
admin = $shiro1$SHA-256$500000$XwFNnp9qlwtKC3lObKqGQQ==$0z8kQBHgyLIX4NLlIWC1oSOaF6e71nho9QRhZedGeTM=, admin
pliu = $shiro1$SHA-256$500000$0qkTih9/Wph2rRCOrK12mA==$Dx7PnsW2FNjg8Nsk0OXCBkuyuyScwHqLT/xE79kBTGA=, admin
jdarmont = $shiro1$SHA-256$500000$O7qXLbAUkKcc1r2tilJprQ==$es19ME5urGPMVBqBc6L2etDsVwW6FXl9hwQi5U4IPZ8=, admin
sloudcher = $shiro1$SHA-256$500000$W/YhSJxuB+t+wfguBALlyg==$Tp5wmGEDYgOdS8cnC8t+zLEUDfUM3rgxMu6AUhZlmVU=, admin
</pre>

<p>
The hash of the password is generated by using the shiro-tools-hasher.jar which can be downloaded from <a href="https://repo1.maven.org/maven2/org/apache/shiro/tools/shiro-tools-hasher/1.4.0/" class="urlextern" title="https://repo1.maven.org/maven2/org/apache/shiro/tools/shiro-tools-hasher/1.4.0/" rel="ugc nofollow">https://repo1.maven.org/maven2/org/apache/shiro/tools/shiro-tools-hasher/1.4.0/</a>
</p>
<pre class="code"># downlad the jar file and run the following command
java -jar shiro-tools-hasher-1.3.2.jar -p

# type your password here
Password to hash: 
Password to hash (confirm): 
$shiro1$SHA-256$500000$W/YhSJxuB+t+wfguBALlyg==$Tp5wmGEDYgOdS8cnC8t+zLEUDfUM3rgxMu6AUhZlmVU=
</pre>

<p>
Note: Shiro only accepts a salted hash of a password.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;1. File authentication&quot;,&quot;hid&quot;:&quot;file_authentication&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;543-1716&quot;} -->
<h2 class="sectionedit3" id="ldap_authentication">2. LDAP authentication</h2>
<div class="level2">

<p>
Shiro provides two possible way to connect to an OpenLDAP server
</p>
<ul>
<li class="level1"><div class="li"> LdapGroupRealm</div>
</li>
<li class="level1"><div class="li"> LdapRealm</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;2. LDAP authentication&quot;,&quot;hid&quot;:&quot;ldap_authentication&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:3,&quot;range&quot;:&quot;1717-1851&quot;} -->
<h3 class="sectionedit4" id="ldapgrouprealm_config">2.1 LdapGroupRealm config</h3>
<div class="level3">

<p>
The ldapGroupRealm is very easy to configure, but it has limited flexibility with mapping of ldap groups to users and for authorization for user groups. Below is a config example
</p>
<pre class="code">[main]
ldapRealm = org.apache.zeppelin.realm.LdapGroupRealm
# search base for ldap groups (only relevant for LdapGroupRealm):
ldapRealm.contextFactory.environment[ldap.searchBase] = dc=udl,dc=org
ldapRealm.contextFactory.url = ldap://lin01.udl.org:389
ldapRealm.userDnTemplate = uid={0},ou=Users,dc=udl,dc=org
ldapRealm.contextFactory.authenticationMechanism = simple</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;2.1 LdapGroupRealm config&quot;,&quot;hid&quot;:&quot;ldapgrouprealm_config&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:4,&quot;range&quot;:&quot;1852-2452&quot;} -->
<h3 class="sectionedit5" id="ldaprealm_config">2.2 LdapRealm config</h3>
<div class="level3">

<p>
The LdapRealm allows for mapping of ldapgroups to roles and also allows for role/group based authentication into the zeppelin server. Sample configuration for this realm is given below.
</p>
<pre class="code">[main]
ldapRealm=org.apache.zeppelin.realm.LdapRealm

ldapRealm.contextFactory.authenticationMechanism=simple
ldapRealm.contextFactory.url=ldap://lin01.udl.org:389
ldapRealm.userDnTemplate=uid={0},ou=Users,dc=udl,dc=org
# Ability to set ldap paging Size if needed default is 100
ldapRealm.pagingSize = 200
ldapRealm.authorizationEnabled=true
ldapRealm.contextFactory.systemAuthenticationMechanism=simple
ldapRealm.searchBase= dc=udl,dc=org
ldapRealm.userSearchBase = dc=udl,dc=org
ldapRealm.groupSearchBase = ou=groups,dc=udl,dc=org
ldapRealm.groupObjectClass=groupofnames
# Allow userSearchAttribute to be customized
ldapRealm.userSearchAttributeName = sAMAccountName
ldapRealm.memberAttribute=member
# force usernames returned from ldap to lowercase useful for AD
ldapRealm.userLowerCase = true
# ability set searchScopes subtree (default), one, base
ldapRealm.userSearchScope = subtree;
ldapRealm.groupSearchScope = subtree;
ldapRealm.memberAttributeValueTemplate=cn={0},ou=Users,dc=udl,dc=org
ldapRealm.contextFactory.systemUsername=uid=guest,ou=Users,dc=udl,dc=org
ldapRealm.contextFactory.systemPassword=S{ALIAS=ldcSystemPassword}
# enable support for nested groups using the LDAP_MATCHING_RULE_IN_CHAIN operator
ldapRealm.groupSearchEnableMatchingRuleInChain = true
# optional mapping from physical groups to logical application roles
ldapRealm.rolesByGroup = LDN_USERS: user_role, NYK_USERS: user_role, HKG_USERS: user_role, GLOBAL_ADMIN: admin_role
# optional list of roles that are allowed to authenticate. Incase not present all groups are allowed to authenticate (login).
# This changes nothing for url specific permissions that will continue to work as specified in [urls].
ldapRealm.allowedRolesForAuthentication = admin_role,user_role
ldapRealm.permissionsByRole= user_role = *:ToDoItemsJdo:*:*, *:ToDoItem:*:*; admin_role = *
securityManager.sessionManager = $sessionManager
securityManager.realms = $ldapRealm</pre>

<p>
A working example
</p>
<pre class="code">ldapRealm = org.apache.zeppelin.realm.LdapRealm
ldapRealm.contextFactory.url = ldap://lin01.udl.org:389
ldapRealm.contextFactory.authenticationMechanism = simple
ldapRealm.contextFactory.systemUsername = cn=admin,dc=udl,dc=org
ldapRealm.contextFactory.systemPassword = changeMe
ldapRealm.authorizationEnabled = true
ldapRealm.userSearchBase = ou=Users,dc=udl,dc=org
ldapRealm.groupSearchBase = ou=Roles,dc=udl,dc=org
ldapRealm.userObjectClass = InetOrgPerson
ldapRealm.groupObjectClass = groupofnames
ldapRealm.userSearchAttributeName = uid
ldapRealm.memberAttribute = member
# the first role name is the ldap role name, the second is the shiro role name which declared in section [roles] of the shiro.ini file 
ldapRealm.rolesByGroup = Admin: admin

</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;2.2 LdapRealm config&quot;,&quot;hid&quot;:&quot;ldaprealm_config&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:5,&quot;range&quot;:&quot;2453-5400&quot;} -->
<h2 class="sectionedit6" id="apache_directory">3. Apache Directory</h2>
<div class="level2">
<pre class="code">activeDirectoryRealm = org.apache.zeppelin.realm.ActiveDirectoryGroupRealm
activeDirectoryRealm.systemUsername = userNameA
activeDirectoryRealm.systemPassword = passwordA
activeDirectoryRealm.hadoopSecurityCredentialPath = jceks://file/user/zeppelin/conf/zeppelin.jceks
activeDirectoryRealm.searchBase = CN=Users,DC=SOME_GROUP,DC=COMPANY,DC=COM
activeDirectoryRealm.url = ldap://ldap.test.com:389
activeDirectoryRealm.groupRolesMap = &quot;CN=aGroupName,OU=groups,DC=SOME_GROUP,DC=COMPANY,DC=COM&quot;:&quot;group1&quot;
activeDirectoryRealm.authorizationCachingEnabled = false
activeDirectoryRealm.principalSuffix = @corp.company.net</pre>

<p>
Also instead of specifying systemPassword in clear text in shiro.ini administrator can choose to specify the same in “hadoop credential”. Create a keystore file using the hadoop credential commandline, for this the hadoop commons should be in the classpath 
</p>
<pre class="code">hadoop credential create activeDirectoryRealm.systempassword -provider jceks://file/user/zeppelin/conf/zeppelin.jceks</pre>

<p>
Change the following values in the Shiro.ini file, and uncomment the line: 
</p>
<pre class="code">activeDirectoryRealm.hadoopSecurityCredentialPath = jceks://file/user/zeppelin/conf/zeppelin.jceks</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;3. Apache Directory&quot;,&quot;hid&quot;:&quot;apache_directory&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:6,&quot;range&quot;:&quot;5401-6649&quot;} -->
<h2 class="sectionedit7" id="pam">4. PAM</h2>
<div class="level2">

<p>
PAM authentication support allows the reuse of existing authentication moduls on the host where Zeppelin is running. On a typical system modules are configured per service for example sshd, passwd, etc. under /etc/pam.d/. You can either reuse one of these services or create your own for Zeppelin. Activiting PAM authentication requires two parameters: 1. realm: The Shiro realm being used 2. service: The service configured under /etc/pam.d/ to be used. The name here needs to be the same as the file name under /etc/pam.d/
</p>
<pre class="code">[main]
 pamRealm=org.apache.zeppelin.realm.PamRealm
 pamRealm.service=sshd</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;4. PAM&quot;,&quot;hid&quot;:&quot;pam&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:7,&quot;range&quot;:&quot;6650-7286&quot;} -->
<h2 class="sectionedit8" id="knox_sso">5. Knox SSO</h2>
<div class="level2">

<p>
KnoxSSO provides an abstraction for integrating any number of authentication systems and SSO solutions and enables participating web applications to scale to those solutions more easily. Without the token exchange capabilities offered by KnoxSSO each component UI would need to integrate with each desired solution on its own.
</p>

<p>
To enable this, apply the following change in <strong>conf/shiro.ini under [main] section</strong>.
</p>
<pre class="code">### A sample for configuring Knox JWT Realm
knoxJwtRealm = org.apache.zeppelin.realm.jwt.KnoxJwtRealm
## Domain of Knox SSO
knoxJwtRealm.providerUrl = https://domain.example.com/
## Url for login
knoxJwtRealm.login = gateway/knoxsso/knoxauth/login.html
## Url for logout
knoxJwtRealm.logout = gateway/knoxssout/api/v1/webssout
knoxJwtRealm.redirectParam = originalUrl
knoxJwtRealm.cookieName = hadoop-jwt
knoxJwtRealm.publicKeyPath = /etc/zeppelin/conf/knox-sso.pem
knoxJwtRealm.groupPrincipalMapping = group.principal.mapping
knoxJwtRealm.principalMapping = principal.mapping
# This is required if KNOX SSO is enabled, to check if &quot;knoxJwtRealm.cookieName&quot; cookie was expired/deleted.  
authc = org.apache.zeppelin.realm.jwt.KnoxAuthenticationFilter</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;5. Knox SSO&quot;,&quot;hid&quot;:&quot;knox_sso&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:8,&quot;range&quot;:&quot;7287-8494&quot;} -->
<h2 class="sectionedit9" id="authorizations">6. Authorizations</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;6. Authorizations&quot;,&quot;hid&quot;:&quot;authorizations&quot;,&quot;codeblockOffset&quot;:10,&quot;secid&quot;:9,&quot;range&quot;:&quot;8495-8525&quot;} -->
<h3 class="sectionedit10" id="role_definition">6.1 Role definition</h3>
<div class="level3">

<p>
If you use file authentication, you can define different roles here and associate them with user login in the [user] section
</p>
<pre class="code">[roles]
role1 = *
role2 = *
role3 = *
admin = *</pre>

<p>
If you use Ldap/AD, the roles are imported from the LDAP/AD server.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;6.1 Role definition&quot;,&quot;hid&quot;:&quot;role_definition&quot;,&quot;codeblockOffset&quot;:10,&quot;secid&quot;:10,&quot;range&quot;:&quot;8526-8815&quot;} -->
<h3 class="sectionedit11" id="policy_rules">6.2 Policy rules</h3>
<div class="level3">

<p>
By default, anyone who defined in [users] can share Interpreter Setting, Credential, and Configuration information in Apache Zeppelin. Sometimes you might want to hide this information for your use case. Since Shiro provides <abbr title="Uniform Resource Locator">URL</abbr>-based security, you can hide the information by commenting or uncommenting these below lines in conf/shiro.ini.
</p>
<pre class="code">[urls]
/api/interpreter/** = authc, roles[admin]
/api/configurations/** = authc, roles[admin]
/api/credential/** = authc, roles[admin]</pre>

<p>
The above config means only users with admin role can see Interpreter Setting, Credential and Configuration information. If you want to grant this permission to other users, you can change roles[ ] as you defined at [users] section.
</p>

<p>
Note: authc means user must be authenticated.
</p>

</div>

<h4 id="multiple_roles_for_one_policy_rule">6.2.1 Multiple roles for one policy rule</h4>
<div class="level4">
<pre class="code">[urls]
/api/interpreter/** = authc, roles[admin, role1]</pre>

<p>
Here, user with admin or role1 role can see interpreter settings.
</p>

</div>

<h4 id="mix_role_and_users">6.2.2 Mix role and users</h4>
<div class="level4">

<p>
Sometime you just want to authorize one use not a group of users. You can do the following
</p>
<pre class="code"># active user authorization
[main]
anyofrolesuser = org.apache.zeppelin.utils.AnyOfRolesUserAuthorizationFilter

[urls]

/api/interpreter/** = authc, anyofrolesuser[admin, user1]</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;6.2 Policy rules&quot;,&quot;hid&quot;:&quot;policy_rules&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:11,&quot;range&quot;:&quot;8816-10127&quot;} -->
<h2 class="sectionedit12" id="common_problems">7. Common problems</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;7. Common problems&quot;,&quot;hid&quot;:&quot;common_problems&quot;,&quot;codeblockOffset&quot;:14,&quot;secid&quot;:12,&quot;range&quot;:&quot;10128-10159&quot;} -->
<h3 class="sectionedit13" id="config_overwrites">7.1 Config overwrites</h3>
<div class="level3">

<p>
If you use ambari to manage zeppelin. You need to modify your shiro.ini via <abbr title="Graphical User Interface">GUI</abbr> of Ambari. Because, if you change it directly in the vm when ambari restart the zeppelin, it will overwrite the shiro.ini by its version. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;7.1 Config overwrites&quot;,&quot;hid&quot;:&quot;config_overwrites&quot;,&quot;codeblockOffset&quot;:14,&quot;secid&quot;:13,&quot;range&quot;:&quot;10160-&quot;} -->